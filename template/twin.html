<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AETHER | Digital Twin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root {
            /* Palette (Consistent with previous pages) */
            --bg-body: #F9FAFB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --accent-primary: #2563EB; 
            --accent-hazard: #EF4444; 
            --accent-safe: #10B981;  
            --line-color: #E5E7EB;
        }

        body {
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* UI Overlay Layer */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass through to 3D canvas */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .brand {
            pointer-events: auto;
            background: rgba(255,255,255,0.9);
            padding: 1rem 1.5rem;
            border: 1px solid var(--line-color);
            border-radius: 0px;
            backdrop-filter: blur(5px);
        }

        .h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: -0.02em; display:flex; align-items:center; gap:10px;}
        .dot { width: 8px; height: 8px; background: var(--accent-primary); border-radius: 50%; }
        
        .nav-links a {
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-right: 15px;
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .nav-links a:hover { color: var(--text-primary); border-bottom: 1px solid var(--text-primary); }

        /* Status Panel */
        .status-panel {
            pointer-events: auto;
            background: rgba(255,255,255,0.95);
            border: 1px solid var(--line-color);
            padding: 1.5rem;
            width: 300px;
            align-self: flex-end;
        }

        .mono { font-family: 'Space Mono', monospace; font-size: 0.85rem; }
        .label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); display: block; margin-bottom: 5px; letter-spacing: 0.05em; }
        .value { font-size: 1.2rem; font-weight: 500; }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px dashed var(--line-color);
            padding-bottom: 0.5rem;
        }
        .status-row:last-child { margin-bottom: 0; border: none; padding: 0; }

        /* Canvas Container */
        #canvas-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }

    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="ui-layer">
        
        <div class="header">
            <div class="brand">
                <div class="h1">
                    <div class="dot"></div>
                    AETHER DIGITAL TWIN
                </div>
                <div class="nav-links" style="margin-top:10px;">
                    <a href="index.html">← Dashboard</a>
                    <a href="#" style="color:var(--text-primary); font-weight:500;">Spatial View</a>
                </div>
            </div>

            <div class="brand" style="text-align:right;">
                <div class="label">VISUAL LEGEND</div>
                <div style="display:flex; gap:15px; font-size:0.8rem; margin-top:5px;">
                    <span style="color:var(--accent-primary)">■ Airflow</span>
                    <span style="color:var(--accent-hazard)">■ Hazard Zone</span>
                    <span style="color:var(--text-secondary)">■ Sensor Frustum</span>
                </div>
            </div>
        </div>

        <div class="status-panel">
            <div class="status-row">
                <div>
                    <span class="label">Zone Status</span>
                    <span class="value" id="zone-status">SECURE</span>
                </div>
                <div class="mono" id="sim-time">00:00:00</div>
            </div>

            <div class="status-row">
                <div>
                    <span class="label">Ventilation Rate</span>
                    <span class="value" id="vent-rate">PASSIVE</span>
                </div>
                <div class="mono" style="color:var(--accent-primary)" id="cfm-val">12 CFM</div>
            </div>

            <div style="margin-top:10px; font-size:0.75rem; color:var(--text-secondary);">
                Rendered via WebGL • Three.js r128
            </div>
        </div>
    </div>

    <script>
        // --- THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        
        // Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xF9FAFB); // Match CSS background
        scene.fog = new THREE.Fog(0xF9FAFB, 10, 50);

        // Camera
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(8, 6, 8);
        camera.lookAt(0, 1, 0);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2; // Don't go below floor

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        scene.add(dirLight);

        // --- OBJECTS (The "Lab") ---

        // 1. Floor Grid (Engineering aesthetic)
        const gridHelper = new THREE.GridHelper(20, 20, 0xE5E7EB, 0xE5E7EB);
        scene.add(gridHelper);

        const planeGeometry = new THREE.PlaneGeometry(20, 20);
        const planeMaterial = new THREE.ShadowMaterial({ opacity: 0.05 });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        // 2. The Workbench (Simple Geometry)
        const tableGroup = new THREE.Group();

        // Table Top
        const topGeo = new THREE.BoxGeometry(4, 0.1, 2);
        // Make the material a variable so we can change color on hazard
        const topMat = new THREE.MeshLambertMaterial({ color: 0xffffff }); 
        const tableTop = new THREE.Mesh(topGeo, topMat);
        tableTop.position.y = 1.5;
        tableTop.castShadow = true;
        tableTop.receiveShadow = true;
        tableGroup.add(tableTop);

        // Legs
        const legGeo = new THREE.BoxGeometry(0.1, 1.5, 0.1);
        const legMat = new THREE.MeshLambertMaterial({ color: 0x333333 });
        
        const positions = [[-1.8, 1.8], [1.8, 1.8], [-1.8, -0.8], [1.8, -0.8]]; // Adjusted for table depth
        positions.forEach(pos => {
            const leg = new THREE.Mesh(legGeo, legMat);
            leg.position.set(pos[0], 0.75, pos[1]); // Half height
            leg.castShadow = true;
            tableGroup.add(leg);
        });

        scene.add(tableGroup);

        // 3. Ventilation Hood (Wireframe above table)
        const hoodGeo = new THREE.BoxGeometry(4.2, 0.5, 2.2);
        const hoodEdges = new THREE.EdgesGeometry(hoodGeo);
        const hoodLine = new THREE.LineSegments(hoodEdges, new THREE.LineBasicMaterial({ color: 0x9CA3AF }));
        hoodLine.position.set(0, 4, 0); // Above table
        scene.add(hoodLine);

        // 4. Vision Camera Frustum (The "Eye")
        const camGeo = new THREE.ConeGeometry(0.5, 1, 4, 1, true); // Pyramid
        const camMat = new THREE.MeshBasicMaterial({ color: 0x2563EB, wireframe: true, transparent: true, opacity: 0.3 });
        const camCone = new THREE.Mesh(camGeo, camMat);
        camCone.position.set(2, 3, 2); // Corner of room
        camCone.lookAt(0, 1.5, 0); // Look at table center
        camCone.rotateX(Math.PI/2); // Adjust orientation
        scene.add(camCone);

        // 5. Particle System (Airflow)
        const particleCount = 200;
        const particlesGeo = new THREE.BufferGeometry();
        const posArray = new Float32Array(particleCount * 3);
        const speedArray = new Float32Array(particleCount); // To store individual speeds

        for(let i = 0; i < particleCount * 3; i+=3) {
            // Random positions within the table area
            posArray[i] = (Math.random() - 0.5) * 4; // x
            posArray[i+1] = 1.5 + Math.random() * 2; // y (start above table)
            posArray[i+2] = (Math.random() - 0.5) * 2; // z
            
            speedArray[i/3] = 0.01 + Math.random() * 0.02; // Initial slow speed
        }

        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        
        const particleMat = new THREE.PointsMaterial({
            size: 0.05,
            color: 0x2563EB,
            transparent: true,
            opacity: 0.6
        });

        const particleSystem = new THREE.Points(particlesGeo, particleMat);
        scene.add(particleSystem);


        // --- SIMULATION LOGIC ---
        
        let isHazard = false;
        let fanSpeed = 1; // 1 = passive, 5 = active

        const ui = {
            status: document.getElementById('zone-status'),
            vent: document.getElementById('vent-rate'),
            cfm: document.getElementById('cfm-val'),
            time: document.getElementById('sim-time')
        };

        // Update Clock
        setInterval(() => {
            ui.time.innerText = new Date().toLocaleTimeString('en-US', {hour12:false});
        }, 1000);

        // The Simulation Loop (matches other pages)
        function runSimulationCycle() {
            setTimeout(() => {
                // HAZARD DETECTED
                isHazard = true;
                topMat.color.setHex(0xEF4444); // Table turns red
                camCone.material.color.setHex(0xEF4444); // Camera sees it
                camCone.material.opacity = 0.8;
                
                ui.status.innerText = "HAZARD DETECTED";
                ui.status.style.color = "var(--accent-hazard)";
            }, 3000);

            setTimeout(() => {
                // FAN ACTIVATES (Particles speed up)
                fanSpeed = 8;
                particleMat.color.setHex(0x10B981); // Green particles (cleaning)
                
                ui.vent.innerText = "MAX EXTRACT";
                ui.vent.style.color = "var(--accent-primary)";
                ui.cfm.innerText = "850 CFM";
            }, 4500);

            setTimeout(() => {
                // RESOLVED
                isHazard = false;
                fanSpeed = 1;
                
                topMat.color.setHex(0xffffff); // Table white
                camCone.material.color.setHex(0x2563EB); // Camera blue
                camCone.material.opacity = 0.3;
                particleMat.color.setHex(0x2563EB); // Blue particles

                ui.status.innerText = "SECURE";
                ui.status.style.color = "var(--text-primary)";
                ui.vent.innerText = "PASSIVE";
                ui.vent.style.color = "var(--text-primary)";
                ui.cfm.innerText = "12 CFM";

            }, 10000);
        }

        // Run every 15s
        setInterval(runSimulationCycle, 15000);
        setTimeout(runSimulationCycle, 1000); // Start soon

        // --- ANIMATION LOOP ---

        function animate() {
            requestAnimationFrame(animate);

            // Animate Particles
            const positions = particleSystem.geometry.attributes.position.array;
            
            for(let i = 1; i < particleCount * 3; i+=3) {
                // Move Y up
                positions[i] += speedArray[(i-1)/3] * fanSpeed;

                // Reset if too high
                if(positions[i] > 4) {
                    positions[i] = 1.5;
                }
            }
            particleSystem.geometry.attributes.position.needsUpdate = true;

            // Camera subtle drift
            // controls.update(); // only needed if autoRotate is on, but we want manual control

            renderer.render(scene, camera);
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>